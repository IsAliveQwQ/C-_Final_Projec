# 漫畫租書系統 WinFormsApp

## 專案簡介
本專案為 C# WinForms 桌面應用程式，結合 MySQL 資料庫，提供漫畫租借、預約、管理員後台等完整功能。
支援用戶與管理員分權、完整歷史紀錄查詢、UI 友善、資料一致性高。

---

## 目錄結構
```
WinFormsApp1/         # 主程式碼與表單
  ├─ UserForm.cs      # 使用者介面主程式
  ├─ AdminForm.cs     # 管理員介面主程式
  ├─ DBHelper.cs      # 資料庫操作輔助類
  ├─ Program.cs       # 程式進入點
  ├─ *.Designer.cs    # WinForms 設計器自動產生檔
  ├─ database_init.sql# 資料庫初始化 SQL
  └─ ...              # 其他表單與資源
WinFormsApp1.sln      # Visual Studio 解決方案
README.md             # 本說明文件
DEVELOPMENT_PLAN.md   # 開發計畫與進度
```

---

## 安裝與執行

### 1. 環境需求
- Windows 10/11
- .NET 7.0 (或以上)
- MySQL 8.0 (或相容版本)

### 2. 套件安裝
- NuGet：`MySql.Data` (已於 csproj 設定)

### 3. 資料庫初始化
1. 建立 MySQL 資料庫（如：`comic_rental`）。
2. 執行 `WinFormsApp1/database_init.sql` 初始化資料表與測試資料。
3. 如需修改連線字串，請編輯 `DBHelper.cs` 內的 `connectionString`。

### 4. 執行專案
- 以 Visual Studio 開啟 `WinFormsApp1.sln`，建置並執行。
- 預設管理員帳號：`admin` / `admin123`
- 測試用戶帳號：`user1` / `user123`、`user2` / `user123`

---

## 功能說明

### 使用者端
- 查詢漫畫（多欄位模糊查詢）
- 借書、還書（含冷卻期、預約優先權）
- 預約、取消預約（24 小時內有效，取消僅更新狀態不刪除紀錄）
- - 使用者預約後24小時內，可隨時在預約紀錄操作欄點擊「取消預約」按鈕，取消自己的預約。
- - 取消預約後，該預約紀錄狀態會標記為「已取消」，但不會從資料庫刪除，完整保留歷史。
- - 只有「預約成功」狀態的預約才會顯示「取消預約」按鈕。
- 查詢完整借閱/預約歷史紀錄（含已還、已取消、已到期），並可對借閱中的紀錄進行還書操作，對預約中的紀錄進行取消預約操作。

#### 資料一致性與UI同步保證
- 所有借書、還書、預約、取消預約等操作，皆會直接更新資料庫。
- UI 顯示內容（主表、右側詳細資訊、按鈕狀態）每次都根據資料庫最新內容即時刷新，不依賴快取或DataGridView行資料。
- 每次操作後自動查詢資料庫最新狀態並刷新UI，確保資料一致且無快取問題。
- 所有狀態、按鈕啟用/禁用、顯示內容都只根據資料庫查詢結果，完全符合規範。

### 管理員端
- 用戶管理（新增、刪除、重設密碼）
- 漫畫管理（新增、刪除、查詢）
- 借閱/預約紀錄查詢
- 權限分離：管理員登入時無法於使用者介面進行借書/預約等操作

最重要的補充：
書被借走時，任何人都不能預約（不論冷卻期、是否預約過）。
只有還書後，才重新開放預約。
【最終正確規則總結】
1. 書未被借出、無人預約
任何人可借、可預約。
2. 書未被借出，有人預約
只有預約者可借，其他人不可借、不可預約。
3. 書被借出
任何人都不可預約、不可借（除了還書操作）。
借書者還書後，才重新開放預約/借閱。
4. 冷卻期
借書者還書後24小時內，該用戶不可再借、不可預約同一本書。
預約者預約後24小時內，不可再預約同一本書。
5. 借書時自動取消自己預約
如果自己有預約，借書時自動取消該預約紀錄。
【狀態表】
| 狀態 | 借閱按鈕 | 預約按鈕 | 備註 |
|--------------|------------------|------------------|------------------------------|
| 無人預約未借 | 可借 | 可預約 | |
| 有人預約 | 只有預約者可借 | 其他人不可預約 | |
| 已借出 | 不可借 | 不可預約 | 任何人都不能預約 |
| 還書 | 可借/可預約 | | 冷卻期內的用戶不可借/預約 |
| 冷卻期 | 不可借 | 不可預約 | |
【UI/資料同步】
書被借出時，預約按鈕必須禁用，狀態顯示「不可預約」。
還書後，預約按鈕才啟用，狀態顯示「可預約」。
所有操作後，所有表格與詳細資訊都要刷新。


---

## 資料表設計（摘要）

- `users`：用戶資料（含管理員標記）
- `comics`：漫畫資料
- `rentals`：借閱紀錄
- `reservations`：預約紀錄（含 status 狀態，保留所有歷史）

詳見 `database_init.sql`。

---

## 資料庫連線

- 連線字串設定於 `DBHelper.cs`，如需更改請依實際環境調整。

---

## 重要開發/維護規範

### **請所有開發者務必遵守以下流程：**

1. **修改前，請務必詳細閱讀本 README 文件，充分理解專案架構與規範。**
2. **所有重大修改，需經專案負責人或團隊討論同意後方可進行。**
3. **每次修改完成且確認無錯誤後，請於 README 的「更新紀錄」區塊記錄進度與內容。**
4. **嚴禁未經許可直接刪除資料表紀錄，所有歷史紀錄必須完整保留（如預約取消僅更新狀態）。**
5. **如有新功能或重大調整，請同步更新本 README 文件與 DEVELOPMENT_PLAN.md。**
6. **所有 UI 事件與資料庫操作必須使用 async/await，嚴禁在 UI 執行緒上使用 .Wait()、.Result 等同步等待，確保 UI不卡頓、效能最佳。**

---

## 更新紀錄

- 2024/05/21：初版 README，明確規範開發與維護流程。
- 2024/05/22：修正預約取消僅更新狀態，歷史紀錄完整保留。
- 2024/05/23：
  - 修復多個程式錯誤：包括處理 DataGridView 欄位名稱錯誤 (`System.ArgumentException`)、空值引用 (`System.NullReferenceException`) 等問題，提升程式碼穩健性。
  - 完善異步處理：確保 UI 不阻塞，將耗時的資料庫操作 (`DBHelper` 方法呼叫) 包裹在 `await Task.Run(...)` 中，使其在背景執行緒執行，符合高效能要求。
  - 還原借閱/預約紀錄操作按鈕：恢復在借閱和預約紀錄列表中直接進行還書或取消預約的操作按鈕功能。
  - 遵循業界標準：在異步編程方面採用推薦模式，並增加必要的空值檢查和異常處理，提高程式碼的可靠性與維護性。
  - 解決編譯錯誤與警告：修正了 `CS0103` (方法未定義) 和 `CS1998` (async 方法缺少 await) 等編譯問題。

- 2024/05/24：
  - **解決登入後表單載入卡頓問題：**
    - **問題根源：** 在使用者表單初始化階段，同步執行了耗時的資料庫查詢操作（特別是載入首頁漫畫列表），阻塞了 UI 線程，導致表單長時間無回應（約十秒卡頓）。
    - **解決方案：** 對首頁漫畫列表的資料載入方法 `RefreshUserComicsGrid` 進行了全面的異步化改造，將資料庫查詢移至後台線程 (`await Task.Run`)。移除了在 `SetupHomePageLayout` 中對 `RefreshUserComicsGrid` 的同步調用，改為在 `UserForm_Load` 事件中通過異步方法 `RefreshAllSectionsAsync` 統一異步載入。確保所有對 UI 元素的更新都在 UI 線程上執行 (`this.Invoke`)。
    - **效益：** 顯著提升了使用者登入後表單的載入速度和應用程式的響應性，消除了卡頓現象。
  - **統一預約紀錄分頁顯示：**
    - **問題根源：** 預約紀錄列表在不同情況下顯示不一致（有時顯示「到期時間」欄位，有時不顯示；狀態文字有時是「canceled」，有時是「已取消」）。這源於資料來源結構或 DataGridView 設定邏輯的不穩定。
    - **解決方案：** 確保 `QueryReserveRecordsAsync` 方法穩定查詢包含 `expiry_date` 欄位並使用中文狀態文字「已取消」。強化 `SetReserveGridSettingsAndButtonStatus` 方法，使其能夠根據一個預定義的欄位列表，穩定地設定 DataGridView 的欄位標題、寬度和顯示順序，並隱藏意外出現的欄位。修改 `RefreshReserveRecordsAsync`，使其在獲取資料後，直接在 UI 線程上完成 `DataSource` 設定和 `SetReserveGridSettingsAndButtonStatus` 的調用，確保數據和 UI 設定的同步一致。
    - **效益：** 確保了預約紀錄分頁每次顯示都具有統一的欄位、順序和樣式，提高了使用者界面的穩定性和一致性。
  - **優化借閱/預約紀錄操作後的刷新邏輯：**
    - **問題根源：** 在借閱紀錄或預約紀錄分頁進行操作（還書、取消預約）後，如果只刷新當前分頁，首頁漫畫列表和其他相關分頁的狀態可能不會立即更新，導致資訊不一致。
    - **解決方案：** 在 `dgvBorrowRecord_CellContentClick` (還書後) 和 `dgvReserveRecord_CellContentClick` (取消預約後) 方法中，除了刷新當前記錄列表，額外增加了對 `RefreshAllSectionsAsync()` 的異步調用。
    - **效益：：** 確保在記錄分頁執行操作後，所有相關聯的分頁（首頁、借閱紀錄、預約紀錄）都能同步更新到最新狀態，維持了跨分頁的資料一致性。

---

如有任何問題，請聯絡專案負責人或於專案討論區提出。

## 2024/05/21 更新
- 自動修正 AdminForm 用戶管理分頁控制項初始化問題，確保 `新增用戶`、`刪除用戶`、`重設密碼` 按鈕與帳號/密碼輸入框皆正確顯示於操作區。
- 解決因控制項未初始化導致的 NullReferenceException。

## 2024/05/21 再次修正：四大分頁（用戶管理、漫畫管理、借閱紀錄查詢、預約紀錄查詢）操作區 Panel 會正確顯示於最上方，不再被 DataGridView 蓋住，UI 結構更清晰。

- 管理員端漫畫管理分頁新增多欄位搜尋功能（書號、ISBN、書名、作者、出版社、分類）。
- 使用者端搜尋功能支援多欄位模糊查詢。
- 修正漫畫管理分頁新增漫畫操作區不被遮蔽。
- 管理員端漫畫管理分頁搜尋、新增、刪除功能已融合於同一操作區，UI分層更清楚，操作更直覺。
- 漫畫管理分頁 UI 已優化：搜尋區和新增/刪除區分層顯示，欄位不重複，按鈕可見且位置合理，整體布局更清晰。
- 漫畫管理分頁 UI 再次優化：全面修正 Designer 程式碼，確保搜尋區和新增/刪除區分層獨立，元件不重複且位置正確，解決遮擋問題，界面更加簡潔直觀。

## 資料顯示與刷新邏輯規範

### 1. 統一的分頁查詢機制
- 所有分頁（用戶、漫畫、借閱、預約）採用統一的分頁查詢機制
- 每頁顯示 10 筆資料（PageSize = 10）
- 分頁按鈕（上一頁/下一頁）根據資料量動態啟用/禁用
- 分頁標籤顯示當前頁碼

### 2. 搜尋與刷新邏輯
- 搜尋時重置分頁到第一頁（currentPage = 1）
- 搜尋參數（關鍵字、搜尋類型）保存在全域變數中
- 刷新按鈕使用當前搜尋參數重新查詢
- 所有查詢都使用分頁機制，避免一次載入過多資料

### 3. 資料同步機制
- 所有資料操作（新增、刪除、修改）後立即刷新相關分頁
- 使用 async/await 確保 UI 不阻塞
- 所有資料操作都在 try-catch 中處理，確保錯誤不會影響 UI

### 4. 效能優化
- 使用參數化查詢避免 SQL 注入
- 只查詢需要的欄位，避免 SELECT *
- 使用適當的索引提升查詢效能
- 大量資料操作使用批次處理

### 5. 程式碼結構
- 使用統一的方法命名規範（如 RefreshXXXRecordsAsync）
- 將 SQL 查詢邏輯封裝在獨立方法中
- 使用常數定義固定值（如 PageSize）
- 適當的註解說明複雜邏輯 